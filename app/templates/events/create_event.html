{% extends "base.html" %}
{% import "bootstrap/wtf.html" as wtf %}
{% block title %}Create Event{% endblock %}

{% block page_content %}
    <div class="container">
        <h2>Create Event</h2>
        <form method="POST" action="">
            {{ form.hidden_tag() }}
            <div class="form-group">
                {{ form.show_name.label(class="form-control-label") }}
                {{ form.show_name(class="form-control") }}
            </div>
            <div class="form-group">
                {{ form.show_number.label(class="form-control-label") }}
                {{ form.show_number(class="form-control") }}
            </div>
            <div class="form-group">
                {{ form.account_manager.label(class="form-control-label") }}
                {{ form.account_manager(class="form-control") }}
            </div>
            <div class="form-group">
                {{ form.location.label(class="form-control-label") }}
                {{ form.location(class="form-control") }}
                <a href="{{ url_for('events.add_location') }}" class="btn btn-link">Add new location</a>
            </div>
            <div class="form-group">
                {{ form.sharepoint.label(class="form-control-label") }}
                {{ form.sharepoint(class="form-control") }}
            </div>
            <div class="form-group">
                {{ form.active.label(class="form-control-label") }}
                {{ form.active(class="form-control") }}
            </div>
            <div class="form-group">
                {{ form.submit(class="btn btn-primary") }}
            </div>
        </form>
    </div>
    <h2>Event List</h2>
    <div id="event-report">
        <table class="table table-bordered table-striped table-hover">
            <thead>
                <tr>
                    <th>Show Name</th>
                    <th>Show Number</th>
                    <th>Account Manager</th>
                    <th>Location</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for event in events %}
                <tr>
                    <td>{{ event.show_name }}</td>
                    <td>{{ event.show_number }}</td>
                    <td>{{ event.account_manager.first_name }} {{ event.account_manager.last_name }}</td>
                    <td>{{ event.location }}</td>
                    <td>{{ 'Active' if event.active else 'Inactive' }}</td>
                    <td>
                        <button class="btn btn-danger" data-event-id="{{ event.id }}" onclick="confirmDelete(this)">Delete</button>
                        <a href="{{ url_for('events.view_event', event_id=event.id) }}" class="btn btn-info">View Details</a>
                        <a href="{{ url_for('events.edit_event', event_id=event.id) }}" class="btn btn-warning">Edit</a>
                        <form id="delete-event-form-{{ event.id }}" action="{{ url_for('events.delete_event', event_id=event.id) }}" method="POST" style="display: inline;">
                            {{ event_form.hidden_tag() }}
                            <button type="button" class="btn btn-danger" onclick="confirmDelete(this)">Delete</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

<script>
function confirmDelete(button) {
    const eventId = button.getAttribute('data-event-id');
    if (confirm("Are you sure you want to delete this event? This action cannot be undone.")) {
        document.getElementById('delete-event-form-' + eventId).submit();
    }
}

function setEventStatus(button) {
    const eventId = button.getAttribute('data-event-id');
    const status = button.getAttribute('data-status');
    
    fetch(`/events/set_event_status/${eventId}/${status}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
        }
    }).then(response => {
        if (response.ok) {
            location.reload();
        } else {
            alert('Failed to update event status.');
        }
    }).catch(error => console.error('Error:', error));
}
</script>
