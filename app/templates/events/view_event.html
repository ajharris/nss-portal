{% extends "base.html" %}
{% from "bootstrap/wtf.html" import form_field %}

{% block page_content %}
<div class="container">
    <h2>Event: {{ event.show_number }}, {{ event.show_name }}</h2>

    {% if (current_user.is_admin or current_user.is_account_manager) and not session.get('view_as_employee', False) %}
    <div id="request-crew-section">
        <h3>Request Crew</h3>
        <form method="POST" action="{{ url_for('events.view_event', event_id=event.id) }}" id="crewRequestForm">
            {{ crew_request_form.hidden_tag() }}
            <input type="hidden" name="crew_id" value="{{ crew_request_form.crew_id.data }}">
            <!-- Other fields here -->
            <div class="form-group">
                {{ form_field(crew_request_form.description, class="form-control") }}
            </div>
            <div class="form-row">
                <div class="form-group col-md-4">
                    {{ form_field(crew_request_form.start_time, class="form-control datetimepicker") }}
                </div>
                <div class="form-group col-md-4">
                    {{ form_field(crew_request_form.end_time, class="form-control datetimepicker") }}
                </div>
                <div class="form-group col-md-4">
                    <label>Shift Type</label>
                    <div class="horizontal-checkbox-group">
                        {% for shift in crew_request_form.shift_type %}
                            <div class="form-check form-check-inline">
                                {{ shift(class="form-check-input") }}
                                <label class="form-check-label">{{ shift.label }}</label>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label>Roles</label>
                <div class="row">
                    {% for role in ROLES %}
                        <div class="form-group col-md-3">
                            <label>{{ role }}</label>
                            <input type="number" name="{{ role }}" value="0" class="form-control role-count">
                        </div>
                    {% endfor %}
                </div>
            </div>
            <input type="hidden" id="roles_json" name="roles_json">
            <div class="form-group">
                {{ form_field(crew_request_form.submit, class="btn btn-primary") }}
            </div>
        </form>
        
    </div>
    {% endif %}

    <div id="crew-assignments-section">
        <h3>Crew Assignments</h3>
        {% for crew_info in crew_assignments %}
        <div class="crew-report">
            <h4>{{ crew_info.crew.description }}</h4>
            <div class="form-row">
                <div class="form-group col-md-4">
                    <p><strong>Start Time:</strong> {{ crew_info.crew.start_time }}</p>
                </div>
                <div class="form-group col-md-4">
                    <p><strong>End Time:</strong> {{ crew_info.crew.end_time }}</p>
                </div>
                <div class="form-group col-md-4">
                    <p><strong>Shift Type:</strong> {{ crew_info.crew.shift_type | capitalize }}</p>
                </div>
            </div>
            <table class="table">
                <thead>
                    <tr>
                        <th>Role</th>
                        <th>Name</th>
                        <th>Phone</th>
                        <th>Email</th>
                    </tr>
                </thead>
                <tbody>
                    {% for role, count in crew_info.crew.get_roles().items() %}
                        {% for i in range(count) %}
                        <tr>
                            <td>{{ role }}</td>
                            {% if crew_info.assignments[i] %}
                                <td>{{ crew_info.assignments[i].worker.first_name }} {{ crew_info.assignments[i].worker.last_name }}</td>
                                <td>{{ crew_info.assignments[i].worker.phone_number }}</td>
                                <td>{{ crew_info.assignments[i].worker.email }}</td>
                            {% else %}
                                <td colspan="3">Not Yet Assigned</td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    {% endfor %}
                </tbody>
            </table>
            {% if (current_user.is_admin or current_user.is_account_manager) and not session.get('view_as_employee', False) %}
            <form method="POST" action="{{ url_for('events.delete_crew', crew_id=crew_info.crew.id) }}">
                {{ crew_request_form.hidden_tag() }}
                <button type="submit" class="btn btn-danger">Delete</button>
            </form>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    
    
    <h3>Notes</h3>
    <form method="POST" action="{{ url_for('events.view_event', event_id=event.id) }}">
        {{ note_form.hidden_tag() }}
        <div class="form-group">
            {{ form_field(note_form.notes, class="form-control") }}
        </div>
        <div class="form-group">
            {{ form_field(note_form.account_manager_only) }}
            <label>{{ note_form.account_manager_only.label }}</label>
        </div>
        <div class="form-group">
            {{ form_field(note_form.account_manager_and_td_only) }}
            <label>{{ note_form.account_manager_and_td_only.label }}</label>
        </div>
        <div class="form-group">
            {{ form_field(note_form.submit, class="btn btn-primary") }}
        </div>
    </form>

    <h3>Documents</h3>
    <form method="POST" enctype="multipart/form-data" action="{{ url_for('events.view_event', event_id=event.id) }}">
        {{ document_form.hidden_tag() }}
        <div class="form-group">
            {{ form_field(document_form.document, class="form-control") }}
        </div>
        <div class="form-group">
            {{ form_field(document_form.submit, class="btn btn-primary") }}
        </div>
    </form>

    <h3>SharePoint</h3>
    <form method="POST" action="{{ url_for('events.view_event', event_id=event.id) }}">
        {{ sharepoint_form.hidden_tag() }}
        <div class="form-group">
            {{ form_field(sharepoint_form.sharepoint_link, class="form-control") }}
        </div>
        <div class="form-group">
            {{ form_field(sharepoint_form.submit, class="btn btn-primary") }}
        </div>
    </form>
</div>

<script>
  document.getElementById('crewRequestForm').addEventListener('submit', function(e) {
    var roles = {};
    document.querySelectorAll('.role-count').forEach(function(entry) {
      var roleTitle = entry.name;
      var roleCount = entry.value;
      roles[roleTitle.trim()] = parseInt(roleCount.trim());
    });

    document.getElementById('roles_json').value = JSON.stringify(roles);
  });
</script>

{% endblock %}
