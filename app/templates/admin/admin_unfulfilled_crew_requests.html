<!-- admin/admin_unfulfilled_crew_requests.html -->
{% extends "base.html" %}

{% block page_content %}
<h1>Unfulfilled Crew Requests</h1>

{% for crew in crews %}
    <div class="crew-request">
        <h3>Show: {{ crew.event.showName }} ({{ crew.event.showNumber }})</h3>
        <p>Start: {{ crew.start_time }}</p>
        <p>End: {{ crew.end_time }}</p>
        <p>Description: {{ crew.description }}</p>
        {% for role, count in crew.get_roles().items() if count > 0 %}
            {% set assigned_worker = None %}
            {% for assignment in crew.assignments %}
                {% if assignment.role == role and assignment.status == 'offered' %}
                    {% set assigned_worker = assignment.worker %}
                {% endif %}
            {% endfor %}
            {% if assigned_worker %}
                <div class="form-group">
                    <label>{{ role }}</label>
                    <p>{{ assigned_worker.first_name }} {{ assigned_worker.last_name }} (offered)</p>
                </div>
            {% else %}
                <form method="POST" action="{{ url_for('admin.unfulfilled_crew_requests') }}" id="form_{{ crew.id }}_{{ role }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="crew_id" id="crew_id_{{ crew.id }}_{{ role }}" value="{{ crew.id }}">
                    <input type="hidden" name="role" id="role_{{ crew.id }}_{{ role }}" value="{{ role }}">
                    <div class="form-group">
                        <label>{{ role }}</label>
                        <select name="worker" id="worker_{{ crew.id }}_{{ role }}" class="form-control">
                            <option value="">Select Worker</option>
                            {% for worker_id, worker_name in form.worker.choices %}
                                <option value="{{ worker_id }}">{{ worker_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary">Assign Worker</button>
                    </div>
                </form>
            {% endif %}
        {% endfor %}
    </div>
{% endfor %}
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', (event) => {
    document.querySelectorAll('form').forEach(form => {
        form.addEventListener('submit', (e) => {
            const formData = new FormData(form);
            console.log('Submitting form with data:');
            for (let [key, value] of formData.entries()) {
                console.log(`${key}: ${value}`);
            }
            const crewId = formData.get('crew_id');
            if (!crewId || crewId === '') {
                alert('Crew ID is missing!');
                e.preventDefault();
            }
        });
    });
});
</script>
{% endblock %}
